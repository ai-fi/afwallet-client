

//use afwalletclient::*;
#![feature(map_first_last)]
#![recursion_limit = "128"]
#![feature(proc_macro_hygiene)]
#![feature(decl_macro)]

#[macro_use]
extern crate rocket;
extern crate config;
extern crate curv;
extern crate multi_party_ecdsa;
extern crate rocket_contrib;
extern crate rocksdb;
extern crate uuid;
extern crate zk_paillier;
#[macro_use]
extern crate failure;

#[macro_use]
extern crate error_chain;

extern crate serde;
extern crate serde_json;

#[macro_use]
extern crate log;

#[cfg(test)]
#[macro_use]
extern crate time_test;
extern crate floating_duration;

extern crate crypto;
extern crate jsonwebtoken as jwt;
extern crate rusoto_dynamodb;
extern crate hex;

#[macro_use]
extern crate serde_derive;
pub mod ecdsa;
pub mod util;
pub mod web;
pub mod sdk;

use std::os::raw::{c_int, c_void};


extern "C" fn callback(i: c_int, _c_user_data: *mut c_void) {
    println!("Round{}", i);
}

fn main() {
    /*
    let pk_vec: Vec<u8> = hex::decode("0252072a9cc7029ba1b2311f66d66ca187b3fb803f65e24746277fe8c329a80cb0").unwrap();
    // let pk = GE::from_bytes(&pubkey);
    let pk = bitcoin::PublicKey::from_slice(&pk_vec).unwrap();
    let network: bitcoin::network::constants::Network = "testnet".parse::<bitcoin::network::constants::Network>().unwrap();
    let address = bitcoin::Address::p2wpkh(&pk, network);
    println!("{:}", address);
    let pk_vec: Vec<u8> = hex::decode("026e0baa8877c082c464c6165a165c9fa3e41ee8e1d1494c6e54ba3ef2b15573c6").unwrap();
    // let pk = GE::from_bytes(&pubkey);
    let pk = bitcoin::PublicKey::from_slice(&pk_vec).unwrap();
    let network: bitcoin::network::constants::Network = "testnet".parse::<bitcoin::network::constants::Network>().unwrap();
    let address = bitcoin::Address::p2wpkh(&pk, network);
    println!("{:}", address);
    
    let pk_vec: Vec<u8> = hex::decode("0286035c385eef53d36dcc7623c63f5239ac7d2a467f2742e7bf780eb1989c9ba1").unwrap();
    // let pk = GE::from_bytes(&pubkey);
    let pk = bitcoin::PublicKey::from_slice(&pk_vec).unwrap();
    let network: bitcoin::network::constants::Network = "testnet".parse::<bitcoin::network::constants::Network>().unwrap();
    let address = bitcoin::Address::p2wpkh(&pk, network);
    println!("{:}", address);

    let pk_vec: Vec<u8> = hex::decode("03dc5cb5b15b50156af642ab53466248561d742b2e5b2fdc0f3a988b7f4b1c5b66").unwrap();
    // let pk = GE::from_bytes(&pubkey);
    let pk = bitcoin::PublicKey::from_slice(&pk_vec).unwrap();
    let network: bitcoin::network::constants::Network = "testnet".parse::<bitcoin::network::constants::Network>().unwrap();
    let address = bitcoin::Address::p2wpkh(&pk, network);
    println!("{:}", address);
    
    let pk_vec: Vec<u8> = hex::decode("02d1ca4eebd5958305ceb1a0e1190019e6a917c8fdc1d3a95126671a1aff036f39").unwrap();
    // let pk = GE::from_bytes(&pubkey);
    let pk = bitcoin::PublicKey::from_slice(&pk_vec).unwrap();
    let network: bitcoin::network::constants::Network = "testnet".parse::<bitcoin::network::constants::Network>().unwrap();
    let address = bitcoin::Address::p2wpkh(&pk, network);
    println!("{:}", address);
    
    let psbt_hex = "70736274ff0100710200000001a0ccaaaad5b014ddeb3ff8023a3ecf31c02c463da1f870796a05497d552cbf820100000000fdffffff02320000000000000016001437fe957c1d1975c87479d3ce2ac3c5579d78f4d9d885010000000000160014bf4bbea2d824ef578d7dc9968ff42cf52e05a1ba82f11b00000100f50200000000010196bbf42c6c1f3d0dae036061b0c3dadafe68b797c733b1f3b60afcdc6a7eaef70000000017160014578f248dbd6babe85b68efc264f32c27675b8cfefeffffff02a2c5100000000000160014e0f3b8cf1c96b09362ab78f9d7c8d9814d44393ca086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96b0247304402204711fa799d6c67570986e28360cc9183d3baf0c90884e32968a658ab325180980220679c0034e8215324ec90b76a435338452a3753240f9a7e82b116d2e4ff6a7e33012103cd7e6fa75291ff788ecb678bba4af21472d442530a26da16ec283ceec10354e67ef11b00220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a00000000000000000022020388c882d5e3682513de49209c1580277d3501b7b3329bbd235e31258619ae786e0c76f2321a000000000100000000220203a3e7c634f9a39ff0e5ec483253ce447d94050a2e4f6349b3373f87fa38bac2240c76f2321a010000000000000000";
    let psbt = bitcoin::util::psbt::PartiallySignedTransaction::from_hex_string(psbt_hex);
    println!("{:?}", psbt);
    let psbt_hex = "70736274ff01009a0200000002a0ccaaaad5b014ddeb3ff8023a3ecf31c02c463da1f870796a05497d552cbf820100000000fdffffffa93e2afbe68acffb22d46c56039310db83cee51af799c496d78b86fb4447fec90000000000fdffffff02320000000000000016001437fe957c1d1975c87479d3ce2ac3c5579d78f4d93c0c030000000000160014bf4bbea2d824ef578d7dc9968ff42cf52e05a1ba87f11b00000100f50200000000010196bbf42c6c1f3d0dae036061b0c3dadafe68b797c733b1f3b60afcdc6a7eaef70000000017160014578f248dbd6babe85b68efc264f32c27675b8cfefeffffff02a2c5100000000000160014e0f3b8cf1c96b09362ab78f9d7c8d9814d44393ca086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96b0247304402204711fa799d6c67570986e28360cc9183d3baf0c90884e32968a658ab325180980220679c0034e8215324ec90b76a435338452a3753240f9a7e82b116d2e4ff6a7e33012103cd7e6fa75291ff788ecb678bba4af21472d442530a26da16ec283ceec10354e67ef11b00220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a0000000000000000000100f502000000000101715decddd992a86d192771c77679dc9c34f152cccfab8d63fa066a73f22fc57e000000001716001420899fc9e4a85a7d5c4696bcf751cb9c98f94a9cfeffffff02a086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96ba6b64d00000000001600140c7639a33fb35d95ac5e38901f178554d5cd94d30247304402200829ef84a89e63e5af808607b29af759a9125b264a7cfbdbf95a436d592c0ebc0220222254187835770098e38735856f48065d73961b2162a890e30e48913a5d0808012102b3d791a3e7eb085798d8448e41139f189945ecbade53ea1e9da0879e2118cf3e86f11b00220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a00000000000000000022020388c882d5e3682513de49209c1580277d3501b7b3329bbd235e31258619ae786e0c76f2321a000000000100000000220203a3e7c634f9a39ff0e5ec483253ce447d94050a2e4f6349b3373f87fa38bac2240c76f2321a010000000000000000";
    let psbt = bitcoin::util::psbt::PartiallySignedTransaction::from_hex_string(psbt_hex);
    println!("{:?}", psbt);
    */
    
    /*
    let psbt_hex = "70736274ff01009a0200000002a0ccaaaad5b014ddeb3ff8023a3ecf31c02c463da1f870796a05497d552cbf820100000000fdffffffa93e2afbe68acffb22d46c56039310db83cee51af799c496d78b86fb4447fec90000000000fdffffff02320000000000000016001437fe957c1d1975c87479d3ce2ac3c5579d78f4d93c0c030000000000160014bf4bbea2d824ef578d7dc9968ff42cf52e05a1ba87f11b000001011fa086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96b220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a00000000000000000001011fa086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96b220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a00000000000000000022020388c882d5e3682513de49209c1580277d3501b7b3329bbd235e31258619ae786e0c76f2321a000000000100000000220203a3e7c634f9a39ff0e5ec483253ce447d94050a2e4f6349b3373f87fa38bac2240c76f2321a010000000000000000";
    let psbt = bitcoin::util::psbt::PartiallySignedTransaction::from_hex_string(psbt_hex);
    println!("{:?}", psbt);


    let bz_vec = std::fs::read("/Users/mingtaichang/Desktop/psbts/1.psbt").unwrap();
    let psbt_hex = hex::encode(&bz_vec);
    let psbt = bitcoin::util::psbt::PartiallySignedTransaction::from_hex_string(&psbt_hex);
    println!("{:?}", psbt);
    
    let null: *mut c_void = std::ptr::null_mut();

    let nc = sdk::network::NetworkClient::new("{\"server\": \"http://127.0.0.1:8000\"}");
    let wallet = String::from("[\"b005db4f-c3cf-4f58-88fa-eceefcf30e76\",{\"u_i\":\"5af9be91745cb1faf114a3bfc93475a138481969749f794e4cbff3c3538aec06\",\"y_i\":{\"x\":\"1e199b3ffba956e0c1d612389626c405c9fcbb0589e8d4af277257bad6f43992\",\"y\":\"657c698c5fd5d4657cd71889786149d8622cce4b01706fd1eb24405430a2cb7c\"},\"dk\":{\"p\":\"102436931575215908658203758544580405192187269228355640162861178028649765883151729595079365648148253732035589929082645712436864984305260138327649770095562852806624345825579767655523755473074982051956259274594251398208240029887916522019272966806888071508555391049261047860399587853726252959533977359454072597359\",\"q\":\"137719376209865103603864297088871968058661589559917292221397605997582203197267480731806265637194330308669145126776956734686086512441372194357209105501308719587113339747646387473406248721754468562324898583325912377456619072070474800982530430846368761312643240010577103094850765256459716856586177508246563282059\"},\"ek\":{\"n\":\"14107550317391369263575463507015434182923004620199500800448925994447321135196177984568045819936245893125423502854322785339519193156963117749573003448024256131633277379894492731953435879913802019305654271839378741523056036615760644794537058994163510522644745328335949388556091621824287287832718208894982246355699621216515700145199754292162726238226880977123697951320440492310065321112128693483342525896671001734837709922544910385719227735963737912270114963280659165453684525783897524791334895017889996564378823428084870601384092515056078959343761987414261335372085364008224029567030922285601471748180533450889855482181\"},\"party_index\":2},{\"y\":{\"x\":\"3fb18e0171552e90c2f375a72ba0675ef550549c9c94b7c8a4d13468f980dd3c\",\"y\":\"6b96b3354277eeac5b7074a4fca720a2b6350733177c825368a6ecd8f12beaea\"},\"x_i\":\"4de56cca5b6c85533a538c3868e0dd67b7fb305735d6b759458b8a69fc3f9065\"},2,[{\"parameters\":{\"threshold\":1,\"share_count\":2},\"commitments\":[{\"x\":\"87f754025d1b84f24f3b7af040e5e89482239e9cbc8c0d35e22fe64acbeb8908\",\"y\":\"ffa2bf312332a132f5e6b0b4093a7b2246ce11d147b2b2010e9e8d336bed7ad9\"},{\"x\":\"f0429553a8e948bc2f37aeb34a9332e3564a000a51ac39c4d9dd463b4eb4018a\",\"y\":\"76e79dc34017736bf48349641a13b0abf5f5a69b768320d9f0fa1230b53313ad\"}]},{\"parameters\":{\"threshold\":1,\"share_count\":2},\"commitments\":[{\"x\":\"1e199b3ffba956e0c1d612389626c405c9fcbb0589e8d4af277257bad6f43992\",\"y\":\"657c698c5fd5d4657cd71889786149d8622cce4b01706fd1eb24405430a2cb7c\"},{\"x\":\"e3cde950682eca66246bb853c4da8b9a2f1591a1b50e2e39c11e20984e92f8c6\",\"y\":\"4047660622423497c17682b686d7e685ba392f6c9f5f0b4445532096a303447b\"}]}],[{\"n\":\"13010173158918407480357961972061506572933617878293332040618341922085557262603492137627290080151272304984986742974562854648811965243708104573125205923498490658475729205101951641692870198963236953084012043096516569504782170459872747751715262356027338259844080787490221056310982055420810813704885421985189636638649025121976886732989974382479599220312000286022700868168030090156125831664869805273167686568906498296369922521988781852915777705670947212087385770233063295389461487648895402406264499877025150449737523800409959967374281726657242926040249744658597581615642020895188247480538948722275408286901290616189075960613\"},{\"n\":\"14107550317391369263575463507015434182923004620199500800448925994447321135196177984568045819936245893125423502854322785339519193156963117749573003448024256131633277379894492731953435879913802019305654271839378741523056036615760644794537058994163510522644745328335949388556091621824287287832718208894982246355699621216515700145199754292162726238226880977123697951320440492310065321112128693483342525896671001734837709922544910385719227735963737912270114963280659165453684525783897524791334895017889996564378823428084870601384092515056078959343761987414261335372085364008224029567030922285601471748180533450889855482181\"}],{\"x\":\"3fb18e0171552e90c2f375a72ba0675ef550549c9c94b7c8a4d13468f980dd3c\",\"y\":\"6b96b3354277eeac5b7074a4fca720a2b6350733177c825368a6ecd8f12beaea\"},\"35d5fb5a2bde95f1246415fb84e9e138c3d5d039fc977ca007e1b4d0ee339d1c\"]");
    println!("{}", wallet);
    let path = String::from("m/0'/0'");
    let msg: Vec<u8> = hex::decode("657c698c5fd5d4657cd71889786149d8622cce4b01706fd1eb24405430a2cb7c").unwrap();
    let result = sdk::sign::sign(&nc, &wallet, &path, &msg, callback, null).expect("Failed to sign message");

    let sign_result = serde_json::to_string(&result).unwrap();
    println!("{}", sign_result);
    */

    let psbt_hex = "70736274ff01009a0200000002a0ccaaaad5b014ddeb3ff8023a3ecf31c02c463da1f870796a05497d552cbf820100000000fdffffffa93e2afbe68acffb22d46c56039310db83cee51af799c496d78b86fb4447fec90000000000fdffffff02320000000000000016001437fe957c1d1975c87479d3ce2ac3c5579d78f4d93c0c030000000000160014bf4bbea2d824ef578d7dc9968ff42cf52e05a1ba87f11b000001011fa086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96b220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a00000000000000000001011fa086010000000000160014c7dc8bceca0e4dc46708266a4b5d1833ecf4d96b220602099b456492ab6918b0f87748daf39c2a94a0af0840ca888fffd4b5cfab127fa50c76f2321a00000000000000000022020388c882d5e3682513de49209c1580277d3501b7b3329bbd235e31258619ae786e0c76f2321a000000000100000000220203a3e7c634f9a39ff0e5ec483253ce447d94050a2e4f6349b3373f87fa38bac2240c76f2321a010000000000000000";
    let psbt = bitcoin::util::psbt::PartiallySignedTransaction::from_hex_string(psbt_hex);
    println!("{:?}", psbt);

    let nc = sdk::network::NetworkClient::new("{\"server\": \"http://127.0.0.1:8000\"}");
    let wallet = String::from("[\"b005db4f-c3cf-4f58-88fa-eceefcf30e76\",{\"u_i\":\"5af9be91745cb1faf114a3bfc93475a138481969749f794e4cbff3c3538aec06\",\"y_i\":{\"x\":\"1e199b3ffba956e0c1d612389626c405c9fcbb0589e8d4af277257bad6f43992\",\"y\":\"657c698c5fd5d4657cd71889786149d8622cce4b01706fd1eb24405430a2cb7c\"},\"dk\":{\"p\":\"102436931575215908658203758544580405192187269228355640162861178028649765883151729595079365648148253732035589929082645712436864984305260138327649770095562852806624345825579767655523755473074982051956259274594251398208240029887916522019272966806888071508555391049261047860399587853726252959533977359454072597359\",\"q\":\"137719376209865103603864297088871968058661589559917292221397605997582203197267480731806265637194330308669145126776956734686086512441372194357209105501308719587113339747646387473406248721754468562324898583325912377456619072070474800982530430846368761312643240010577103094850765256459716856586177508246563282059\"},\"ek\":{\"n\":\"14107550317391369263575463507015434182923004620199500800448925994447321135196177984568045819936245893125423502854322785339519193156963117749573003448024256131633277379894492731953435879913802019305654271839378741523056036615760644794537058994163510522644745328335949388556091621824287287832718208894982246355699621216515700145199754292162726238226880977123697951320440492310065321112128693483342525896671001734837709922544910385719227735963737912270114963280659165453684525783897524791334895017889996564378823428084870601384092515056078959343761987414261335372085364008224029567030922285601471748180533450889855482181\"},\"party_index\":2},{\"y\":{\"x\":\"3fb18e0171552e90c2f375a72ba0675ef550549c9c94b7c8a4d13468f980dd3c\",\"y\":\"6b96b3354277eeac5b7074a4fca720a2b6350733177c825368a6ecd8f12beaea\"},\"x_i\":\"4de56cca5b6c85533a538c3868e0dd67b7fb305735d6b759458b8a69fc3f9065\"},2,[{\"parameters\":{\"threshold\":1,\"share_count\":2},\"commitments\":[{\"x\":\"87f754025d1b84f24f3b7af040e5e89482239e9cbc8c0d35e22fe64acbeb8908\",\"y\":\"ffa2bf312332a132f5e6b0b4093a7b2246ce11d147b2b2010e9e8d336bed7ad9\"},{\"x\":\"f0429553a8e948bc2f37aeb34a9332e3564a000a51ac39c4d9dd463b4eb4018a\",\"y\":\"76e79dc34017736bf48349641a13b0abf5f5a69b768320d9f0fa1230b53313ad\"}]},{\"parameters\":{\"threshold\":1,\"share_count\":2},\"commitments\":[{\"x\":\"1e199b3ffba956e0c1d612389626c405c9fcbb0589e8d4af277257bad6f43992\",\"y\":\"657c698c5fd5d4657cd71889786149d8622cce4b01706fd1eb24405430a2cb7c\"},{\"x\":\"e3cde950682eca66246bb853c4da8b9a2f1591a1b50e2e39c11e20984e92f8c6\",\"y\":\"4047660622423497c17682b686d7e685ba392f6c9f5f0b4445532096a303447b\"}]}],[{\"n\":\"13010173158918407480357961972061506572933617878293332040618341922085557262603492137627290080151272304984986742974562854648811965243708104573125205923498490658475729205101951641692870198963236953084012043096516569504782170459872747751715262356027338259844080787490221056310982055420810813704885421985189636638649025121976886732989974382479599220312000286022700868168030090156125831664869805273167686568906498296369922521988781852915777705670947212087385770233063295389461487648895402406264499877025150449737523800409959967374281726657242926040249744658597581615642020895188247480538948722275408286901290616189075960613\"},{\"n\":\"14107550317391369263575463507015434182923004620199500800448925994447321135196177984568045819936245893125423502854322785339519193156963117749573003448024256131633277379894492731953435879913802019305654271839378741523056036615760644794537058994163510522644745328335949388556091621824287287832718208894982246355699621216515700145199754292162726238226880977123697951320440492310065321112128693483342525896671001734837709922544910385719227735963737912270114963280659165453684525783897524791334895017889996564378823428084870601384092515056078959343761987414261335372085364008224029567030922285601471748180533450889855482181\"}],{\"x\":\"3fb18e0171552e90c2f375a72ba0675ef550549c9c94b7c8a4d13468f980dd3c\",\"y\":\"6b96b3354277eeac5b7074a4fca720a2b6350733177c825368a6ecd8f12beaea\"},\"35d5fb5a2bde95f1246415fb84e9e138c3d5d039fc977ca007e1b4d0ee339d1c\"]");
    println!("{}", wallet);
    
    let null: *mut c_void = std::ptr::null_mut();
    let signed_psbt = sdk::sign::sign_psbt(&nc, &wallet, &psbt, callback, null).expect("Failed to sign message");
    println!("signed_psbt:{:}",signed_psbt.to_hex_string().unwrap());
}
